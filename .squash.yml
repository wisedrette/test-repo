deployments:
  default:
    environment:
      - ENV=test
      - DJANGO_SETTINGS_MODULE=path.settings.test
      - CREATE_PLACEHOLDER_CONTENT=False
    dockerimage: ubuntu:18.04
    build_steps:
      - >
        DEBIAN_FRONTEND=noninteractive apt-get update &&
        DEBIAN_FRONTEND=noninteractive apt-get install -y
        software-properties-common
        postgresql postgresql-contrib postgresql-10
        sudo supervisor ssh git curl locales
        gcc build-essential
        libfontconfig1 libfontconfig1-dev libssl-dev libpq-dev
        python3.6 python3.6-dev python3.6-venv python3-pip
      - >
        curl -sL https://deb.nodesource.com/setup_8.x | bash &&
        DEBIAN_FRONTEND=noninteractive apt-get install -y nodejs
      - WORKDIR /code
      - >
        service postgresql start &&
        sudo -u postgres psql -U postgres -c "CREATE USER path WITH PASSWORD 'path';" &&
        sudo -u postgres psql -U postgres -c "CREATE DATABASE pathdb OWNER path;" &&
        echo "127.0.0.1 db" >> /etc/hosts &&
        pg_isready --dbname postgres://path:path@db/pathdb
      - python3 -m venv venv
      - ls -la
    post_build_steps:
      - ls -la /code/venv
    launch_steps:
      - service postgresql start -w
      - sleep 5
      - cd /code
      - ls -la
    run_options: -v ~/code:/code
